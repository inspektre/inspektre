on: push
jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Perform DeepCode analysis
        uses: georgismitev/deepcode-code-scanning-analysis@master
        env:
          DEEPCODE_TOKEN: ${{secrets.DEEPCODE_TOKEN}}
      - uses: actions/checkout@v2
      - uses: inspektre/codeintel-gh@v1
      - uses: actions/upload-artifact@v2
        with:
          name: AppInspectorResults
          path: AppInspectorResults.json
      - name: setup-node
        uses: actions/setup-node@v2-beta
        with:
          node-version: '14'
      - name: install inspektre
        env:
          NPM_CONFIG_PREFIX: "~/.npm-global"
        run: |
          export PATH="$(yarn global bin):$PATH"
          yarn global add @inspektre/inspektre
      - uses: actions/download-artifact@master
        with:
          name: AppInspectorResults
          path: ~/
      - name: inspektre scan
        env:
          INSPEKTRE_TOKEN: ${{secrets.INSPEKTRE_TOKEN}}
          INSPEKTRE_CLIENT_ID: ${{secrets.INSPEKTRE_CLIENT_ID}}
          INSPEKTRE_CLIENT_SECRET: ${{secrets.INSPEKTRE_CLIENT_SECRET}}
        run: |
          ~/.npm-global/bin/inspektre reauthorize
          ~/.npm-global/bin/inspektre inspect -f ~/AppInspectorResults.json --sarif output.sarif --deepcode
